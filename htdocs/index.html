
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Jon Ludlam's Blog</title>
  <meta name="author" content="Jon Ludlam">

  
  <meta name="description" content="We had an issue reported by XenRT that xapi was failing during a
stress test while halting a VM, reporting an internal error from
xenopsd: &ldquo; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jon.recoil.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jon Ludlam's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Jon Ludlam's Blog</a></h1>
  
    <h2>Some development stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jon.recoil.org/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/12/tracking-down-stress-test-bugs-in-xapi/">Tracking Down Stress Test Bugs in Xapi</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-12T15:59:38+01:00" pubdate data-updated="true">Jun 12<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We had an issue reported by XenRT that xapi was failing during a
stress test while halting a VM, reporting an internal error from
xenopsd: &ldquo;Object does not exist in xenopsd&rdquo;.</p>

<p>Looking through /var/log/xensource.log, the API call comes in
for processing at 19:31:44:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>May  2 19:31:44 localhost xapi: [ info|cl11-08|46298 INET 0.0.0.0:80|dispatch:VM.clean_shutdown D:fa4c1c72df7e|taskhelper] task Async.VM.clean_shutdown R:82f033257476 forwarded (trackid=8354dc542edb45d9d747e9c1d992c886)</span></code></pre></td></tr></table></div></figure>


<p>Xapi log lines are very long and contain quite a lot of
info. Decomposing it a bit, this particular line is an info message on
host cl11-08, thread id 46298 from the TCP port listening to
0.0.0.0:80. It&rsquo;s a task called <code>dispatch:VM.clean_shutdown</code>, which has
task id <code>D:fa4c1c72df7e</code>, and comes from a logger named <code>taskhelper</code>,
which is defined
<a href="https://github.com/xapi-project/xen-api/blob/9abf1c73923598b3598e41e539ec49d60c51c588/ocaml/idl/ocaml_backend/taskHelper.ml#L14">here</a>
The log message says that there&rsquo;s a new task &lsquo;Async.VM.clean_shutdown&rsquo;
with task id R:82f033257476, which has been forwarded from the pool
master.</p>

<p>The bit we&rsquo;re interested in here is that the new task id is
<code>R:82f033257476</code>, and we can grep for this in the logs to see only the
messages associated with this API call. Doing that and skipping a few
uninteresting lines, we see that xapi decides this is an OK thing to
process, and in turn tells xenopsd to halt the VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>May  2 19:31:44 localhost xapi: [debug|cl11-08|46298 INET 0.0.0.0:80|Async.VM.clean_shutdown R:82f033257476|mscgen] xapi=&gt;xenops [label="VM.shutdown"];
</span><span class='line'>May  2 19:31:44 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Task 7729 reference Async.VM.clean_shutdown R:82f033257476: ["VM_poweroff", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", [1200.000000]]]</span></code></pre></td></tr></table></div></figure>


<p>The <code>mscgen</code> line shows an internal <code>VM.shutdown</code> call from xapi to
xenopsd.  The entry points for all of the xenopsd API calls are in the
file xenopsd.git/lib/xenops_server.ml, and this particular call is
handled
<a href="https://github.com/xapi-project/xenopsd/blob/25fc99435dbe5093b10f8727198a94097ba22031/lib/xenops_server.ml#L1727">here</a>
which shows why xenopsd logs it as VM_poweroff.</p>

<p>Xenopsd turns this API call into
<a href="https://github.com/xapi-project/xenopsd/blob/25fc99435dbe5093b10f8727198a94097ba22031/lib/xenops_server.ml#L809">several smaller items</a>
and starts processing them, logging when it starts each one:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>May  2 19:31:44 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VM_hook_script", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", "VM_pre_destroy", "clean-shutdown"]]
</span><span class='line'>...
</span><span class='line'>May  2 19:31:44 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VM_shutdown_domain", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", "Halt", 1200.000000]]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:09 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VM_destroy_device_model", "4ab3dfd9-f571-8900-a35a-6cced68267e3"]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:09 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VBD_unplug", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", "xvda"], true]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:25 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VIF_unplug", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", "0"], true]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:26 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VM_destroy", "4ab3dfd9-f571-8900-a35a-6cced68267e3"]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:26 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VBD_epoch_end", [["4ab3dfd9-f571-8900-a35a-6cced68267e3", "xvda"], ["VDI", "0da34c7b-b27b-20c3-7e29-50659204a52e\/9f380254-3a77-452a-aea3-8031226c6cc7"]]]
</span><span class='line'>...
</span><span class='line'>May  2 19:32:45 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Performing: ["VBD_set_active", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", "xvda"], false]
</span><span class='line'>May  2 19:32:45 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] VBD.set_active 4ab3dfd9-f571-8900-a35a-6cced68267e3.xvda false
</span><span class='line'>May  2 19:32:45 localhost xenopsd: [ info|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Caught Xenops_interface.Does_not_exist(_) executing ["VM_poweroff", ["4ab3dfd9-f571-8900-a35a-6cced68267e3", [1200.000000]]]: triggering cleanup actions</span></code></pre></td></tr></table></div></figure>


<p>The first thing to notice is that the system must be really busy, as
it takes over a minute to fail to poweroff the VM. We can also clearly
see that it&rsquo;s in processing the <code>VBD.set_active</code> task that the failure
occurs. Unhelpfully, the body of the exception <code>Does_not_exist</code> has
been hidden, but fortunately xenopsd logs the full details a few lines
later:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>May  2 19:32:45 localhost xenopsd: [debug|cl11-08|7|Async.VM.clean_shutdown R:82f033257476|xenops] Task 7729 failed; exception = ["Does_not_exist", ["VM", "4ab3dfd9-f571-8900-a35a-6cced68267e3\/vbd.xvda"]]</span></code></pre></td></tr></table></div></figure>


<p>and so it&rsquo;s complaining that the <em>VM</em> does not exist. This can only
have happened by a VM.remove call being processed by xenopsd. Grepping
for this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] Processing event: ["Vm", "4ab3dfd9-f571-8900-a35a-6cced68267e3"]
</span><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] xenops event on VM 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|mscgen] xapi=&gt;xenops [label="VM.stat"];
</span><span class='line'>May  2 19:32:31 localhost xenopsd: [debug|cl11-08|13680588|xenops events D:337bbe7c241d|xenops] VM.stat 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] xenopsd event: processing event for VM 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] Will update VM.allowed_operations because power_state has changed.
</span><span class='line'>May  2 19:32:31 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] xenopsd event: Updating VM 4ab3dfd9-f571-8900-a35a-6cced68267e3 power_state &lt;- Halted
</span><span class='line'>May  2 19:32:33 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] xenops_cache: deleting cache for 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:33 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|xenops] xapi_cache: deleting cache for 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:33 localhost xapi: [ info|cl11-08|74|xenops events D:337bbe7c241d|xenops] xenops: VM.remove 4ab3dfd9-f571-8900-a35a-6cced68267e3
</span><span class='line'>May  2 19:32:33 localhost xapi: [debug|cl11-08|74|xenops events D:337bbe7c241d|mscgen] xapi=&gt;xenops [label="VM.remove"];</span></code></pre></td></tr></table></div></figure>


<p>So xapi told xenopsd to remove the VM! The clue here is in the name of
the thread: <code>xenops events</code>.  Xapi has to be able to respond to events
initiated by the VM, for example, the VM may shut down at any time and
xapi needs to reflect this in its database. Therefore a thread exists
in xapi that monitors xenopsd for events. This thread has noticed that
the VM has shut down and attempts to clean things up. Normally this
isn&rsquo;t a problem as xenopsd only marks the VM as shut down when it
performs the <code>VM_destroy</code> towards the end of its shutdown actions, and
in any case it wouldn&rsquo;t usually signal an event on the VM until
completely finishing the sequence.</p>

<p>In this case, probably because the whole system was very busy, the
event thread presumably had a long queue of events to process,
including one that came from this VM from before the shutdown was
initiated. This was then processed at an unfortunate time, leading to
the problem. To confirm, we can inject this sort of failure by
modifying the sequence of events that happens during a shutdown:</p>

<p>From this:</p>

<figure class='code'><figcaption><span>Decompose the poweroff into atomic operations</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">|</span> <span class="nc">VM_poweroff</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">reason</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>        <span class="k">then</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="n">reason__hard_shutdown</span>
</span><span class='line'>        <span class="k">else</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="n">reason__clean_shutdown</span> <span class="k">in</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>        <span class="nc">VM_hook_script</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="nc">VM_pre_destroy</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
</span><span class='line'>    <span class="o">]</span> <span class="o">@</span> <span class="o">(</span><span class="n">atomics_of_operation</span> <span class="o">(</span><span class="nc">VM_shutdown</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">timeout</span><span class="o">))</span>
</span><span class='line'>    <span class="o">)</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vbd</span> <span class="o">-&gt;</span> <span class="nn">Opt</span><span class="p">.</span><span class="n">default</span> <span class="bp">[]</span> <span class="o">(</span><span class="nn">Opt</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">[</span> <span class="nc">VBD_epoch_end</span> <span class="o">(</span><span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="n">x</span><span class="o">)]</span> <span class="o">)</span> <span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">backend</span><span class="o">))</span>
</span><span class='line'>        <span class="o">(</span><span class="nn">VBD_DB</span><span class="p">.</span><span class="n">vbds</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>    <span class="o">))</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vbd</span> <span class="o">-&gt;</span> <span class="nc">VBD_set_active</span> <span class="o">(</span><span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="bp">false</span><span class="o">))</span>
</span><span class='line'>        <span class="o">(</span><span class="nn">VBD_DB</span><span class="p">.</span><span class="n">vbds</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vif</span> <span class="o">-&gt;</span> <span class="nc">VIF_set_active</span> <span class="o">(</span><span class="n">vif</span><span class="o">.</span><span class="nn">Vif</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="bp">false</span><span class="o">))</span>
</span><span class='line'>        <span class="o">(</span><span class="nn">VIF_DB</span><span class="p">.</span><span class="n">vifs</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span> <span class="o">@</span> <span class="o">[</span>
</span><span class='line'>        <span class="nc">VM_hook_script</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="nc">VM_post_destroy</span><span class="o">,</span> <span class="n">reason</span><span class="o">)</span>
</span><span class='line'>    <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>we&rsquo;ll stick in a delay:</p>

<figure class='code'><figcaption><span>Inject the defect</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">|</span> <span class="nc">VM_poweroff</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">reason</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'>      <span class="k">then</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="n">reason__hard_shutdown</span>
</span><span class='line'>      <span class="k">else</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="n">reason__clean_shutdown</span> <span class="k">in</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>      <span class="nc">VM_hook_script</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="nc">VM_pre_destroy</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
</span><span class='line'>  <span class="o">]</span> <span class="o">@</span> <span class="o">(</span><span class="n">atomics_of_operation</span> <span class="o">(</span><span class="nc">VM_shutdown</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">timeout</span><span class="o">))</span>
</span><span class='line'>  <span class="o">)</span> <span class="o">@</span> <span class="o">[</span> <span class="nc">VM_delay</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>  <span class="o">]</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vbd</span> <span class="o">-&gt;</span> <span class="nn">Opt</span><span class="p">.</span><span class="n">default</span> <span class="bp">[]</span> <span class="o">(</span><span class="nn">Opt</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">[</span> <span class="nc">VBD_epoch_end</span> <span class="o">(</span><span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="n">x</span><span class="o">)]</span> <span class="o">)</span> <span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">backend</span><span class="o">))</span>
</span><span class='line'>      <span class="o">(</span><span class="nn">VBD_DB</span><span class="p">.</span><span class="n">vbds</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">))</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vbd</span> <span class="o">-&gt;</span> <span class="nc">VBD_set_active</span> <span class="o">(</span><span class="n">vbd</span><span class="o">.</span><span class="nn">Vbd</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="bp">false</span><span class="o">))</span>
</span><span class='line'>      <span class="o">(</span><span class="nn">VBD_DB</span><span class="p">.</span><span class="n">vbds</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span> <span class="o">@</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">vif</span> <span class="o">-&gt;</span> <span class="nc">VIF_set_active</span> <span class="o">(</span><span class="n">vif</span><span class="o">.</span><span class="nn">Vif</span><span class="p">.</span><span class="n">id</span><span class="o">,</span> <span class="bp">false</span><span class="o">))</span>
</span><span class='line'>      <span class="o">(</span><span class="nn">VIF_DB</span><span class="p">.</span><span class="n">vifs</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span> <span class="o">@</span> <span class="o">[</span>
</span><span class='line'>      <span class="nc">VM_hook_script</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nn">Xenops_hooks</span><span class="p">.</span><span class="nc">VM_post_destroy</span><span class="o">,</span> <span class="n">reason</span><span class="o">)</span>
</span><span class='line'>  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>and separately cause the <code>VM_delay</code> atomic operation to inject an event that xapi
will pick up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">|</span> <span class="nc">VM_delay</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">Updates</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nn">Dynamic</span><span class="p">.</span><span class="nc">Vm</span> <span class="n">id</span><span class="o">)</span> <span class="n">updates</span><span class="o">;</span>
</span><span class='line'>  <span class="n">debug</span> <span class="s2">&quot;VM %s: waiting for %.2f before next VM action&quot;</span> <span class="n">id</span> <span class="n">t</span><span class="o">;</span>
</span><span class='line'>  <span class="nn">Thread</span><span class="p">.</span><span class="n">delay</span> <span class="n">t</span>
</span></code></pre></td></tr></table></div></figure>


<p>where that &lsquo;Updates.add&rsquo; is what will wake xapi.
Compiling this up and uploading it to our server, the problem is easily reproduced:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">[</span><span class="n">root</span><span class="o">@</span><span class="n">st28</span> <span class="o">~]#</span> <span class="n">xe</span> <span class="n">vm</span><span class="o">-</span><span class="n">shutdown</span> <span class="n">vm</span><span class="o">=</span><span class="n">centos</span>
</span><span class='line'><span class="nc">The</span> <span class="n">server</span> <span class="n">failed</span> <span class="k">to</span> <span class="n">handle</span> <span class="n">your</span> <span class="n">request</span><span class="o">,</span> <span class="n">due</span> <span class="k">to</span> <span class="n">an</span> <span class="n">internal</span> <span class="n">error</span><span class="o">.</span>  <span class="nc">The</span> <span class="n">given</span> <span class="n">message</span> <span class="n">may</span> <span class="n">give</span> <span class="n">details</span> <span class="n">useful</span> <span class="k">for</span> <span class="n">debugging</span> <span class="n">the</span> <span class="n">problem</span><span class="o">.</span>
</span><span class='line'><span class="n">message</span><span class="o">:</span> <span class="nc">Object</span> <span class="k">with</span> <span class="k">type</span> <span class="nc">VM</span> <span class="ow">and</span> <span class="n">id</span> <span class="mi">41</span><span class="n">bcbb30</span><span class="o">-</span><span class="mi">31</span><span class="n">b6</span><span class="o">-</span><span class="mi">5</span><span class="n">d97</span><span class="o">-</span><span class="mi">37</span><span class="n">ad</span><span class="o">-</span><span class="n">c8b1f985c064</span><span class="o">/</span><span class="n">vbd</span><span class="o">.</span><span class="n">xvdd</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="k">in</span> <span class="n">xenopsd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we just need to decide how to fix this. It seems bad that invoking
this API call to xenopsd can cause it an internal error, so the
problem should clearly be fixed in xenopsd as opposed to within xapi.
Fortunately xenopsd already has logic for this sort of thing: It has
system of worker threads that perform the larger operations and a way
of queuing operations to be processed. This allows xenopsd to process
several operations at the same time.</p>

<p>When a new VM-specific operation is queued, xenopsd looks to see if a
worker thread is already processing operations on that particular
VM. If so, the operation is given to that worker&rsquo;s personal queue, and
if not, the operation is put onto the default queue. When a worker is
looking for a job to do, it pops the next operation off the default
queue, and also allocates all other operations on the same VM to
itself.  In this way we never have two workers trying to operate on
the same VM.</p>

<p>The solution is therefore to use this mechanism to queue up the VM.remove
behind the VM.shutdown. Unfortunately it&rsquo;s usually only the async
operations that are queued, so we have to add in a bit more logic to
make the operation still appear to be synchronous, while actually
implementing it using the asynchronous task mechanisms.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">commit</span> <span class="n">b8e590ceb968fa87845b75d95ecc85214255e94f</span>
</span><span class='line'><span class="nc">Author</span><span class="o">:</span> <span class="nc">Jon</span> <span class="nc">Ludlam</span> <span class="o">&lt;</span><span class="n">jonathan</span><span class="o">.</span><span class="n">ludlam</span><span class="o">@</span><span class="n">citrix</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
</span><span class='line'><span class="nc">Date</span><span class="o">:</span>   <span class="nc">Thu</span> <span class="nc">Jun</span> <span class="mi">12</span> <span class="mi">23</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">20</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0100</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">Queue</span> <span class="n">the</span> <span class="nn">VM</span><span class="p">.</span><span class="n">remove</span> <span class="n">operation</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">Signed</span><span class="o">-</span><span class="n">off</span><span class="o">-</span><span class="n">by</span><span class="o">:</span> <span class="nc">Jon</span> <span class="nc">Ludlam</span> <span class="o">&lt;</span><span class="n">jonathan</span><span class="o">.</span><span class="n">ludlam</span><span class="o">@</span><span class="n">citrix</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">xenops_server</span><span class="o">.</span><span class="n">ml</span> <span class="n">b</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">xenops_server</span><span class="o">.</span><span class="n">ml</span>
</span><span class='line'><span class="n">index</span> <span class="n">b470891</span><span class="o">..</span><span class="mi">51</span><span class="n">f0b3d</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">xenops_server</span><span class="o">.</span><span class="n">ml</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">xenops_server</span><span class="o">.</span><span class="n">ml</span>
</span><span class='line'><span class="o">@@</span> <span class="o">-</span><span class="mi">1448</span><span class="o">,</span><span class="mi">11</span> <span class="o">+</span><span class="mi">1448</span><span class="o">,</span><span class="mi">20</span> <span class="o">@@</span> <span class="ow">and</span> <span class="n">perform</span> <span class="o">?</span><span class="n">subtask</span> <span class="o">(</span><span class="n">op</span><span class="o">:</span> <span class="n">operation</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span><span class="o">:</span> <span class="nn">Xenops_task</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="n">op</span>
</span><span class='line'>                <span class="o">|</span> <span class="nc">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nn">Xenops_task</span><span class="p">.</span><span class="n">with_subtask</span> <span class="n">t</span> <span class="n">name</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="n">op</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span><span class="k">let</span> <span class="n">queue_operation</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="o">=</span>
</span><span class='line'><span class="o">+</span><span class="k">let</span> <span class="n">queue_operation_int</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">task</span> <span class="o">=</span> <span class="nn">Xenops_task</span><span class="p">.</span><span class="n">add</span> <span class="n">tasks</span> <span class="n">dbg</span> <span class="o">(</span><span class="k">fun</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">perform</span> <span class="n">op</span> <span class="n">t</span><span class="o">;</span> <span class="nc">None</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>        <span class="nn">Redirector</span><span class="p">.</span><span class="n">push</span> <span class="n">id</span> <span class="o">(</span><span class="n">op</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">task</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span><span class="k">let</span> <span class="n">queue_operation</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="o">=</span>
</span><span class='line'><span class="o">+</span>       <span class="k">let</span> <span class="n">task</span> <span class="o">=</span> <span class="n">queue_operation_int</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="k">in</span>
</span><span class='line'>        <span class="n">task</span><span class="o">.</span><span class="nn">Xenops_task</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">let</span> <span class="n">queue_operation_and_wait</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="o">=</span>
</span><span class='line'><span class="o">+</span>       <span class="k">let</span> <span class="n">from</span> <span class="o">=</span> <span class="nn">Updates</span><span class="p">.</span><span class="n">last_id</span> <span class="n">dbg</span> <span class="n">updates</span> <span class="k">in</span>
</span><span class='line'><span class="o">+</span>       <span class="k">let</span> <span class="n">task</span> <span class="o">=</span> <span class="n">queue_operation_int</span> <span class="n">dbg</span> <span class="n">id</span> <span class="n">op</span> <span class="k">in</span>
</span><span class='line'><span class="o">+</span>       <span class="n">event_wait</span> <span class="n">task</span> <span class="o">~</span><span class="n">from</span> <span class="mi">1200</span><span class="o">.</span><span class="mi">0</span> <span class="o">(</span><span class="n">task_finished_p</span> <span class="n">task</span><span class="o">.</span><span class="nn">Xenops_task</span><span class="p">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'> <span class="k">module</span> <span class="nc">PCI</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class='line'>        <span class="k">open</span> <span class="nc">Pci</span>
</span><span class='line'>        <span class="k">module</span> <span class="nc">DB</span> <span class="o">=</span> <span class="nc">PCI_DB</span>
</span><span class='line'><span class="o">@@</span> <span class="o">-</span><span class="mi">1670</span><span class="o">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">1679</span><span class="o">,</span><span class="mi">7</span> <span class="o">@@</span> <span class="k">module</span> <span class="nc">VM</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">add</span> <span class="o">_</span> <span class="n">dbg</span> <span class="n">x</span> <span class="o">=</span>
</span><span class='line'>                <span class="nn">Debug</span><span class="p">.</span><span class="n">with_thread_associated</span> <span class="n">dbg</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">add&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span>       <span class="k">let</span> <span class="n">remove</span> <span class="o">_</span> <span class="n">dbg</span> <span class="n">id</span> <span class="o">=</span> <span class="n">immediate_operation</span> <span class="n">dbg</span> <span class="n">id</span> <span class="o">(</span><span class="nc">Atomic</span><span class="o">(</span><span class="nc">VM_remove</span> <span class="n">id</span><span class="o">))</span>
</span><span class='line'><span class="o">+</span>       <span class="k">let</span> <span class="n">remove</span> <span class="o">_</span> <span class="n">dbg</span> <span class="n">id</span> <span class="o">=</span> <span class="n">queue_operation_and_wait</span> <span class="n">dbg</span> <span class="n">id</span> <span class="o">(</span><span class="nc">Atomic</span> <span class="o">(</span><span class="nc">VM_remove</span> <span class="n">id</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">let</span> <span class="n">stat&#39;</span> <span class="n">x</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">debug</span> <span class="s2">&quot;VM.stat %s&quot;</span> <span class="n">x</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And indeed, with <a href="https://github.com/xapi-project/xenopsd/pull/77">this queuing in place</a> the problem doesn&rsquo;t happen even
with our fault injection code activated.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/06/12/tracking-down-stress-test-bugs-in-xapi/">Tracking Down Stress Test Bugs in Xapi</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jon Ludlam -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
